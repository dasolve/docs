# ADR-010: Moonrepo as the Standard Monorepo Tool

## Context

Dasolve solutions are, by nature, complex systems. They will often be composed of multiple discrete components: frontends, backends, data models, jobs, functions, and specification.

Managing these components in separate repositories (polyrepo) introduces significant friction related to dependency management, code sharing, and consistent tooling. A monorepo approach is a natural fit for Dasolve projects, as it collocates all code, simplifies atomic changes across components, and streamlines dependency management.

However, a monorepo without a specialized tool becomes unmanageable at scale. Developers lose time running `build` and `test` commands for the entire repository, even for a small change. CI/CD pipelines become slow and inefficient.

We require a tool that can:

1. Understand the dependency graph between projects.
2. Run tasks (like `build`, `test`, `lint`) only on projects affected by a change.
3. Cache task outputs (locally and remotely) to avoid redundant work.
4. Orchestrate complex task pipelines efficiently.
5. Scale from small projects to large, polyglot codebases.

## Decision

We will standardize on **Moonrepo (moon)** as the official monorepo orchestrator, task runner, and build system for all Dasolve solutions.

This decision means:

- All new Dasolve solutions will be scaffolded as a Moon-managed monorepo.
- All project-level tasks (e.g., `build`, `test`, `lint`, `dev`) must be defined within Moon's configuration (project-level `moon.yml` files).
- The dependency graph between projects within the monorepo must be explicitly declared in Moon's configuration to enable its "affected projects" logic.
- CI/CD pipelines will be built to use `moon ci` and `moon run` commands, leveraging Moon's remote caching to accelerate builds.
- Moon's toolchain management (`.moon/toolchain.yml`) will be used to enforce consistent behaviours of tools decided in other ADRs, such as **Bun**, **TypeScript** and **Python**.

## Consequences

### Positive

- **High Performance:** Moon is written in Rust and is designed for speed. Its local and remote caching will dramatically reduce build and test times, both locally and in CI.
- **Intelligent Task Orchestration:** By understanding the project dependency graph, `moon run` will only execute tasks on projects that are _actually_ affected by a code change, saving significant developer and CI time.
- **Consistency:** A single interface (`moon run ..., moon check ...`) for all tasks simplifies the developer experience, onboarding, and automation. This is a crucial, simple interface for both human and AI developers.
- **Polyglot Support:** Moon has first-class support for our standardized toolchain including **Bun**, **Python**, **Go**, and **Rust**, making it the ideal orchestrator for our polyglot solutions.
- **Reduced Configuration:** Moon's language-aware "platform" support automatically infers tasks and configurations, reducing the amount of boilerplate required compared to more generic task runners.

### Negative

- **Learning Curve:** Moon is a newer and less-known tool compared to alternatives like Nx or Turborepo. Developers will need to invest time to learn its specific concepts and YAML-based configuration.
- **Strictness:** Moon's power comes from its explicit dependency graph. This requires developers to be diligent in declaring dependencies. Teams accustomed to implicit or loosely managed dependencies will need to adapt.
- **Ecosystem Maturity:** While growing, the community and third-party tooling (e.g., editor extensions, plugins) around Moon are not as extensive as those for its more established competitors.

## Do's and Don'ts

This section provides clear guidelines for adhering to this decision.

### Do

- **DO** define all project tasks in project-level `moon.yml` files or workspace-level `.moon/tasks/*.yml` files.
- **DO** use `moon run <project>:<task>` or `moon check <project>` as the primary method for running tasks.
- **DO** explicitly declare all `dependsOn` relationships between projects in their `moon.yml` configuration.
- **DO** utilize Moon's toolchain (`.moon/toolchain.yml`) to pin versions of our standard stack, including **Bun**, **Go**, **Python**, **Rust**, etc.
- **DO** configure and enable remote caching (Moon Cloud or self-hosted) for all CI/CD pipelines.
- **DO** use `moon ci` as the primary command in CI environments to run all checks and tests on _only_ affected projects.

### Don't

- **DON'T** use other monorepo management tools like Lerna, Nx, or Turborepo.
- **DON'T** bypass Moon by writing custom `bash` scripts for task orchestration.
- **DON'T** use `package.json` scripts for any task logic. All tasks and scripts must be defined and managed exclusively through Moon's `moon.yml` or `.moon/tasks/*.yml` files.
- **DON'T** create implicit dependencies between projects (e.g., using `import ../../other-project/src`) without declaring that dependency in `moon.yml`.
- **DON'T** commit the Moon cache (`.moon/cache`) to source control. This must be in the `.gitignore` file.

## Compliance and Enforcement

1. **Project Scaffolding:** The official Dasolve project generator will only create Moon-configured monorepos. The default `.gitignore` file will exclude the Moon cache.
2. **CI/CD Pipeline:** The CI/CD pipeline will be built to fail if `moon.yml` files are not present or are misconfigured. All build and test steps _must_ be executed via Moon commands.
3. **Code Reviews:** Reviewers must ensure that new projects are correctly integrated into the Moon workspace and that `package.json` scripts are not used for cross-project orchestration.
4. **Exceptions:**
   - Exceptions to this ADR are rare and must be approved by the project's lead architect or the Dasolve framework steering committee.
   - All approved exceptions must be documented as a separate ADR that outlines the business/technical justification and the scope of the exception.
   - An approved exception does _not_ obligate the framework team to provide support or integration for the alternative build system. The team granted the exception assumes all responsibility for its own tooling and CI/CD maintenance.

## References

- **Moonrepo:** [https://moonrepo.dev/docs](https://moonrepo.dev/docs)
