# ADR-004: Python Package Manager

## Context

[ADR-002](./ADR-002.md) establishes Python as the primary language for data-related tasks (Jobs and ML functions). Python projects are highly dependent on external packages from registries like PyPI.

The traditional Python ecosystem for managing dependencies and virtual environments is fragmented, with many competing tools and workflows (e.g., `pip` + `venv`, `poetry`, `pipenv`). This lack of a single standard leads to:

1.  Inconsistent project structures and setup procedures.
2.  Different, incompatible lockfile formats (`poetry.lock`, `Pipfile.lock`, `requirements.txt`).
3.  Slow dependency resolution and installation times.

To ensure consistency, high performance, and reproducible builds for our Python projects, we must standardize on a single, modern tool.

## Decision

The official and mandatory package and environment manager for all Python projects (as defined in ADR-002) is **uv**.

`uv` will be used for all dependency management and virtual environment creation. The standard workflow is:

1.  Use `uv venv` to create a virtual environment.
2.  Use `uv add [package]` or `uv remove [package]` to manage dependencies. These commands automatically update the `pyproject.toml` file and regenerate the `uv.lock` file.
3.  Install all dependencies from the lockfile using `uv sync`.
4.  The `uv.lock` file **must** be committed to version control.

This ADR explicitly forbids the use of `uv pip` commands in favor of this `add/remove/sync` workflow.

## Do's and Don'ts

### Do

- **Do** use `uv venv` to create and manage your virtual environments.
- **Do** use `uv add [package]` and `uv remove [package]` to manage your project's dependencies. These commands are the standard for modifying your dependency set.
- **Do** commit the `uv.lock` file (and the modified `pyproject.toml`) to your Git repository after running `add` or `remove`.
- **Do** use `uv sync` as the primary command to install or update dependencies in your environment, as it installs directly from the lockfile. This is the command all other developers and CI will run.
- **Do** update all `README.md` files to reflect the `uv venv` and `uv sync` setup commands.
- **Do** manually edit `pyproject.toml` _only_ for complex changes (like adding groups of optional dependencies), and then run `uv lock` to regenerate the lockfile. For simple additions/removals, prefer `uv add/remove`.

### Don't

- **Don't** use `uv pip install` or `uv pip uninstall`. The correct commands are `uv add` and `uv remove`.
- **Don't** use `pip`, `python -m venv`, `poetry`, `pipenv`, or `pip-tools`.
- **Don't** use `requirements.txt` files for locking dependencies. `uv.lock` is the standard.
- **Don't** manually edit the `uv.lock` file.
- **Don't** commit your virtual environment directory (e.g., `.venv`). This must be added to `.gitignore`.

## Consequences

- **Positive:**

  - **Extreme Performance:** `uv` is exceptionally fast, drastically reducing time spent on dependency resolution and installation. This improves both local development setup and CI/CD pipeline speeds.
  - **Unified Tool:** `uv` replaces a combination of tools (`pip`, `venv`, `pip-tools`, `poetry`) with a single, coherent, high-performance binary.
  - **Familiar Workflow:** The `add/remove/sync` workflow is familiar to developers coming from `npm`, `yarn`, or `bun`, reducing the learning curve.
  - **Modern & Clean:** Enforces a clean, reproducible dependency management process (`pyproject.toml` + `uv.lock`).

- **Negative:**

  - **Maturity:** `uv` is a very new tool. Its commands and lockfile format are still evolving. We must be prepared for potential breaking changes in early updates.
  - **Adoption Friction:** This is a new workflow for almost all Python developers, who may be used to `pip`, `poetry`, or `conda`.

- **Risks:**
  - **Tooling Integration:** IDEs (like VS Code or PyCharm) are still building first-class integration for `uv`. They may not automatically detect dependency changes or prompt for a `uv sync` as they do for other tools.

## Compliance and Enforcement

- **Enforcement:** Compliance will be enforced through automated tooling and code reviews.

  - **Tooling:** Dasolve project templates for Python tasks will be pre-configured with a `pyproject.toml` and a `.gitignore` file that includes `.venv/` and ignores `requirements.txt`.
  - **CI/CD Pipelines:** All CI/CD scripts for Python projects **must** use `uv sync --frozen` as the installation command. This ensures immutability and fails the build if `uv.lock` is out of sync with `pyproject.toml`.
  - **Code Reviews:** Reviewers must ensure that `uv.lock` is present and that no alternative package managers (`poetry`, `pipenv`) or lockfiles (`poetry.lock`, `Pipfile.lock`, `requirements.txt`) are introduced.

- **Exceptions:** Any exception to use an alternative tool (e.Sg., for a project that has an external, non-negotiable dependency on Poetry or Conda) must be approved by the Dasolve core team and documented in a separate ADR.

## References

- [ADR-002: Primary Language for Data-Related Tasks](./ADR-002.md)
- [uv Official Documentation](https://docs.astral.sh/uv/)
