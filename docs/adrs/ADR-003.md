# ADR-003: JavaScript/TypeScript Package Manager

## Context

[ADR-001](./ADR-001.md) establishes TypeScript as the primary language for general application development. This development lifecycle relies heavily on external packages (dependencies) from the Node.js ecosystem (e.g., npm registry).

To manage these dependencies and ensure reproducible builds, a standard package manager is required. The JavaScript ecosystem has several popular options, including `npm`, `yarn`, `pnpm`, and `bun`.

Without a single standard, teams may use different package managers, leading to:

1.  Multiple competing lockfiles (`package-lock.json`, `yarn.lock`, `bun.lock`) in the same repository, causing confusion.
2.  Inconsistent `node_modules` structures, leading to "it works on my machine" issues.
3.  Varying performance for dependency installation.

Standardizing on one tool for _package management_ is essential for consistency and developer efficiency.

## Decision

The official and mandatory package manager for all JavaScript/TypeScript projects (as defined in ADR-001) is **Bun**.

This decision specifically covers **dependency management tasks only**:

- `bun install`
- `bun add`
- `bun remove`

The `bun.lock` file is the sole source of truth for locked dependencies and **must** be committed to version control.

Other functionalities of the Bun toolchain (e.g., script execution, bundling, testing) are outside the scope of this ADR and will be addressed separately.

## Do's and Don'ts

### Do

- **DO** use `bun install` to install dependencies from a `package.json` file.
- **DO** use `bun add [package]`, `bun add -d [package]`, and `bun remove [package]` to manage your project's dependencies.
- **DO** commit the `bun.lock` file to your Git repository.
- **DO** update `README.md` and other developer setup documentation to reflect that `bun install` is the correct command to install dependencies.

### Don't

- **DON'T** use `npm install`, `npm i`, `yarn add`, `pnpm add`, or any other package management commands from other tools. All _dependency modifications_ must go through `bun`.
- **DON'T** commit `package-lock.json`, `yarn.lock`, or `pnpm-lock.yaml` files to the repository. These should be added to the `.gitignore` file.
- **DON'T** manually edit the `bun.lock` file.

## Consequences

- **Positive:**

  - **Performance:** Bun is significantly faster at installing dependencies, which improves the local developer experience (setup) and CI/CD pipeline speed.
  - **Consistency:** A single, unified lockfile (`bun.lock`) ensures reproducible and reliable builds across all environments.
  - **Foundation for Simplicity:** Standardizing on Bun for package management (as per this ADR) paves the way for potentially adopting its integrated toolchain (runtime, bundler, tester) in the future, as will be defined in subsequent ADRs.

- **Negative:**

  - **Maturity:** Bun is a newer tool compared to `npm` or `yarn`. While stable, it may have undiscovered edge cases or less community support for niche package management issues.
  - **Tooling Integration:** Some older or less-maintained developer tools (e.g., certain IDE extensions) may have better integration with `npm` by default and may require configuration to work with `bun`.

- **Risks:**
  - **Adoption Friction:** Developers accustomed to `npm` or `yarn` must learn new (though very similar) commands. This is considered a minor, one-time cost.
  - **Workspace/Monorepo Support:** While Bun has support for workspaces, it is newer than Yarn's or pnpm's. Complex monorepo dependency graphs may encounter issues, which we must address as they arise.

## Compliance and Enforcement

- **Enforcement:** Compliance will be enforced through automated tooling and code reviews.

  - **Tooling:** Dasolve solution templates will come pre-configured with a `.gitignore` file that explicitly ignores `package-lock.json`, `yarn.lock`, and `pnpm-lock.yaml`.
  - **CI/CD Pipelines:** All CI/CD build scripts for JavaScript/TypeScript projects **must** use `bun install --frozen-lockfile` as the installation command. This ensures immutability and guarantees that the build process does not modify the lockfile.
  - **Code Reviews:** Reviewers must ensure no `npm`/`yarn`/`pnpm` package management commands are used and that no incompatible lockfiles are added to the repository.

- **Exceptions:** Any exception to use an alternative package manager (e.g., for a project that has an external, non-negotiable dependency on `npm`) must be approved by the Dasolve core team and documented in a separate ADR.

## References

- [ADR-001: Primary Programming Language](./ADR-001.md)
- [Bun Official Website](https://bun.sh/)
