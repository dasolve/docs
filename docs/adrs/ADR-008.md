# ADR-008: Toolchain Version Management

## Context

Our selected technology stack is composed of multiple, independent tools, each with its own release cycle:

- `bun` (per [ADR-003](./ADR-003.md) and [ADR-005](./ADR-005.md))
- `node` (as a peer runtime, per [ADR-006](./ADR-006.md))
- `python` (per [ADR-002](./ADR-002.md))
- `uv` (per [ADR-004](./ADR-004.md))

This polyglot environment creates a significant risk of version mismatch. Without a standard, one developer might use `bun` v1.1.0 while another uses `bun` v1.2.0, leading to "it works on my machine" bugs, lockfile conflicts, and non-reproducible builds.

Manually managing this (e.g., via `README.md` instructions) is not scalable. Using tool-specific version managers (like `nvm` or `pyenv`) creates configuration drift and requires developers to manage multiple tools.

We need a single, unified, cross-platform (per [ADR-007](./ADR-007.md)) tool to manage all our toolchain versions from a single, version-controlled file.

## Decision

`proto` (from moonrepo) is the official and mandatory tool for managing and synchronizing toolchain versions across all developers and CI/CD environments.

A single `.prototools` file must be created at the root of each repository. This file will define the exact, pinned versions of all required development tools.

Example `.prototools` file:

```toml
bun = "1.1.10"
node = "20.12.0"
python = "3.11.8"
uv = "0.2.7"
```

This `.prototools` file must be committed to version control. All developers and all CI/CD pipelines will use `proto` to read this file, automatically download the specified versions, and configure the environment `PATH` to use them.

## Do's and Don'ts

### Do

- **DO** install `proto` as the first prerequisite for all local development setup.
- **DO** define all required tools for the project in the root `.prototools` file with exact versions.
- **DO** commit the `.prototools` file to Git.
- **DO** trust `proto` to manage the installation and shimming of your tools.
- **DO** configure CI/CD pipelines to install `proto` and use it to set up the toolchain.
- **DO** update a tool's version by changing it in the `.prototools` file and committing the change.

### Don't

- **DON'T** install bun, node, python, or uv manually (e.g., via brew, apt-get, or official installers). This will conflict with `proto`.
- **DON'T** use other version managers like `nvm`, `asdf`, `pyenv`, or `virtualenv`. `proto` replaces all of them.
- **DON'T** rely on a README.md file to list tool versions. The `.prototools` file is the single source of truth.

## Consequences

- **Positive**:

  - **Perfect Consistency**: Every developer and every CI run will use the exact same tool versions, eliminating a massive class of environment-based bugs.
  - **Single Source of Truth**: Upgrading a tool (e.g., bun from 1.1.10 to 1.2.0) is a single-line change in a version-controlled file, which can be reviewed and rolled back like any other code change.
  - **Onboarding Speed**: A new developer only needs to install `proto`. Running one command will automatically download and install the project's entire toolchain.
  - **Polyglot Management**: `proto` is designed to manage tools from many different ecosystems (Node, Python, etc.) with a single interface.

- **Negative**:

  - **New "Meta" Dependency**: This adds `proto` itself as a new, mandatory tool that everyone must install before they can do anything else.
  - **IDE/Tool Integration**: Some IDEs or scripts may not be "aware" of `proto`'s shims. They may need to be configured to find the `proto`-managed binaries, or the environment must be launched from a `proto`-aware shell.

- **Risks**:
  - **proto Availability/Bugs**: We become dependent on the `proto` tool itself. If it has a bug, or its download sources fail, it can block all development.
  - **Shim Complexity**: Like all PATH-based version managers, debugging "which bun am I using?" can be slightly more complex.

## Compliance and Enforcement

- **CI/CD Pipeline**: This is the primary enforcement point. The first step in any CI job must be to install `proto` and use it to install the tools defined in `.prototools`. The pipeline must not use globally-installed tools from the runner's image (e.g., the pre-installed `node:20` or `python:3.10`).
- **Onboarding Documentation**: The README.md and all developer setup guides must list "Install proto" as the first prerequisite.
- **Code Reviews**: Reviewers must reject any PRs that attempt to install tools manually (e.g., in a `Dockerfile` via `apt-get`, or in CI via `setup-node` actions) instead of adding them to `.prototools`.

## References

- **proto documentation**: https://moonrepo.dev/docs/proto
- This ADR supports the toolchain defined in:
  - [ADR-002](./ADR-002.md): Primary Language for Data-Related Tasks
  - [ADR-003](./ADR-003.md): JavaScript/TypeScript Package Manager
  - [ADR-004](./ADR-004.md): Python Package Manager
  - [ADR-005](./ADR-005.md): Primary TypeScript Runtime
  - [ADR-006](./ADR-006.md): Node.js Peer Runtime for Incompatible Development Tools
  - [ADR-007](./ADR-007.md): Supported Development Operating Systems
