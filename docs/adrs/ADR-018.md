# ADR-018: TanStack Router for Routing

## Context

Single Page Applications ([ADR-015](./ADR-015.md)) require client-side routing to manage navigation between different views without full page reloads. A routing solution must provide:

- **Declarative route definitions** that are easy to understand and maintain
- **Type-safe routing** with compile-time checking for route parameters and search params
- **Code splitting and lazy loading** for optimal performance
- **Built-in data loading** coordinated with route transitions
- **URL state management** for search parameters and filters
- **Nested routing** to support complex application layouts
- **Navigation guards** for authentication and authorization checks

Traditional React routing solutions have limitations:

- **React Router:** Lacks built-in type safety, requires manual TypeScript definitions, no built-in data loading coordination
- **Manual Routing:** Error-prone, difficult to maintain, no type safety
- **Framework Routers (Next.js, Remix):** Require server-side rendering, which violates our SPA architecture ([ADR-015](./ADR-015.md))

For **enterprise applications** with complex navigation flows, type safety is critical to prevent runtime errors from typos in route paths, missing parameters, or invalid search params. Additionally, file-based routing provides an intuitive, scalable way to organize routes as the application grows.

## Decision

All **frontends built on the Dasolve framework** must use **TanStack Router** as the routing library.

TanStack Router will be configured with:

- **File-based routing** in a folder tree structure to define routes
- **Full TypeScript type safety** for routes, params, and search params
- **Route-level code splitting** using lazy loading
- **Data loading coordination** with route transitions
- **Search parameter validation** with type-safe schemas

### File Routing Structure

Routes will be organized in the `src/routes/` directory, with page components in a separate `src/pages/` directory to ensure separation of concerns:

```
src/
├── routes/                 # Route definitions only
│   ├── __root.tsx          # Root layout component
│   ├── index.tsx           # Home route (/)
│   ├── about.tsx           # About route (/about)
│   ├── users/
│   │   ├── index.tsx       # Users list route (/users)
│   │   └── $userId.tsx     # User detail route (/users/:userId)
│   └── dashboard/
│       ├── _layout.tsx     # Dashboard layout
│       ├── index.tsx       # Dashboard home route (/dashboard)
│       ├── analytics.tsx   # Analytics route (/dashboard/analytics)
│       └── settings.tsx    # Settings route (/dashboard/settings)
└── pages/                  # Page components
    ├── HomePage.tsx
    ├── AboutPage.tsx
    ├── UsersListPage.tsx
    ├── UserDetailPage.tsx
    └── dashboard/
        ├── DashboardHomePage.tsx
        ├── AnalyticsPage.tsx
        └── SettingsPage.tsx
```

Route files define loaders, search params validation, and reference page components. Page components contain the actual UI logic.

This decision ensures all Dasolve frontends have type-safe, maintainable routing with excellent developer experience.

## Do's and Don'ts

### Do

- **DO** use TanStack Router for all client-side routing in Dasolve frontends.
- **DO** organize routes using file-based routing in the `src/routes/` directory.
- **DO** leverage TypeScript type safety for route parameters, search params, and navigation.
- **DO** use `getRouteApi()` to access route data in page components. This ties the page component to its route, maintaining consistency and avoiding mistakes.
- **DO** use route-level code splitting with `lazy()` for optimal bundle sizes.
- **DO** define route-level data loading with loaders that execute before route transition.
- **DO** use search parameter schemas with Zod or similar validation libraries for type safety.
- **DO** implement nested routes and layouts using TanStack Router's layout system.
- **DO** use `<Link>` components for navigation to maintain type safety.
- **DO** implement loading states and error boundaries at the route level.

### Don't

- **DON'T** use React Router, Wouter, or other routing libraries. TanStack Router is the standard.
- **DON'T** define routes programmatically without using the file-based routing structure.
- **DON'T** use string literals for route paths in navigation. Use type-safe route objects.
- **DON'T** perform data fetching in components when it should be done in route loaders.
- **DON'T** ignore TypeScript errors in route definitions. They indicate real problems.
- **DON'T** use window.location or manual history manipulation. Use TanStack Router's navigation APIs.
- **DON'T** create deeply nested route hierarchies without good reason. Keep route structures flat when possible.

## Consequences

### Positive

- **Full Type Safety:** Complete TypeScript support ensures compile-time checking of routes, parameters, and navigation, preventing runtime errors.
- **File-Based Routing:** Intuitive folder structure makes routes easy to discover and maintain as the application scales.
- **Built-in Code Splitting:** Automatic route-level code splitting reduces initial bundle size and improves load times.
- **Coordinated Data Loading:** Route loaders execute before navigation, eliminating loading waterfalls and providing better UX.
- **Search Param Management:** Type-safe search parameter handling with validation makes complex filtering and sorting easier.
- **Excellent DX:** Auto-generated route types, IntelliSense support, and compile-time validation improve developer productivity.
- **Active Development:** TanStack Router is actively maintained by the TanStack team with strong community support.
- **Integration:** Seamless integration with TanStack Query ([ADR-019](./ADR-019.md)) for data fetching and caching.

### Negative

- **Learning Curve:** Developers must learn TanStack Router's concepts (file routing, loaders, search params) which differ from React Router.
- **Newer Library:** TanStack Router is newer than React Router, with a smaller ecosystem and fewer community resources.
- **Build-Time Generation:** Route types are generated at build time, requiring the dev server to be running for type checking.
- **Migration Complexity:** Migrating from React Router to TanStack Router requires significant refactoring.

### Risks

- **Breaking Changes:** As a relatively new library, TanStack Router may introduce breaking changes in future versions. This will be mitigated by:
  - Pinning TanStack Router versions in package.json
  - Following semantic versioning and testing upgrades thoroughly
  - Monitoring the TanStack Router changelog and migration guides
- **Type Generation Failures:** Route type generation might fail with complex route structures. This will be mitigated by:
  - Keeping route structures simple and following best practices
  - Running type generation as part of CI/CD to catch issues early
  - Providing clear error messages and debugging guidelines

## Compliance and Enforcement

### Enforcement

- **Project Templates:** All Dasolve frontend scaffolding will include TanStack Router pre-configured with:
  - File-based routing setup in `src/routes/`
  - Type generation configured in `vite.config.ts`
  - Example routes demonstrating best practices
  - Root layout and error boundary components
- **Vite Configuration:** TanStack Router's Vite plugin will be configured to generate route types automatically:

  ```typescript
  import { defineConfig } from "vite";
  import react from "@vitejs/plugin-react";
  import { tanstackRouter } from "@tanstack/router-plugin/vite";

  // https://vitejs.dev/config/
  export default defineConfig({
    plugins: [
      // Please make sure that '@tanstack/router-plugin' is passed before '@vitejs/plugin-react'
      tanstackRouter({
        target: "react",
        autoCodeSplitting: true,
      }),
      react(),
      // ...,
    ],
  });
  ```

- **TypeScript Configuration:** Strict type checking will be enforced for route definitions.
- **Code Reviews:** Reviewers must ensure:
  - All routes are defined using file-based routing
  - Type-safe navigation is used throughout the application
  - Route loaders are used for data fetching instead of useEffect in components
  - Search parameters use validation schemas
- **CI/CD:** Build pipelines will fail if route type generation fails or TypeScript errors exist in route definitions.

### Standard Route Example

Example route file (`src/routes/users/$userId.tsx`):

```typescript
import { createFileRoute } from "@tanstack/react-router";
import { z } from "zod";
import { UserDetailPage } from "../../pages/UserDetailPage";

// Search params schema
const userSearchSchema = z.object({
  tab: z.enum(["profile", "settings", "activity"]).optional(),
});

export const Route = createFileRoute("/users/$userId")({
  // Validate search params
  validateSearch: userSearchSchema,

  // Load data before rendering
  loader: async ({ params }) => {
    const user = await fetchUser(params.userId);
    return { user };
  },

  // Reference page component
  component: UserDetailPage,
});
```

Example page component (`src/pages/UserDetailPage.tsx`):

```typescript
import { getRouteApi } from "@tanstack/react-router";

// Get route API for type-safe access to route data
const route = getRouteApi("/users/$userId");

export function UserDetailPage() {
  const { userId } = route.useParams();
  const { tab } = route.useSearch();
  const { user } = route.useLoaderData();

  return (
    <div>
      <h1>User: {user.name}</h1>
      <p>ID: {userId}</p>
      {tab && <p>Active tab: {tab}</p>}
    </div>
  );
}
```

### Exceptions

- Exceptions to this ADR are rare and must be approved by the project's lead architect or the Dasolve framework core maintainers.
- All approved exceptions must be documented as a separate ADR that outlines the business/technical justification and the scope of the exception.

## References

- [ADR-015: SPA Architecture](./ADR-015.md)
- [ADR-016: React.JS Framework](./ADR-016.md)
- [ADR-017: Vite Build Tool](./ADR-017.md)
- [ADR-019: TanStack Query](./ADR-019.md)
- [TanStack Router Documentation](https://tanstack.com/router)
- [TanStack Router File-Based Routing Guide](https://tanstack.com/router/latest/docs/framework/react/guide/file-based-routing)
