# ADR-022: Azure AD Authentication Support

## Context

Enterprise applications require robust authentication and authorization to:

- **Verify user identity** before granting access to the application
- **Protect sensitive data** from unauthorized access
- **Integrate with enterprise identity systems** (Single Sign-On)
- **Support role-based access control** (RBAC)
- **Comply with security policies** and regulations

For **enterprise environments**, authentication solutions must:

- **Integrate with Azure Active Directory (Azure AD)** - the dominant identity platform in enterprise Microsoft-centric environments
- Support **Single Sign-On (SSO)** for seamless user experience
- Handle **token management** (acquisition, refresh, validation)
- Provide **session management** for long-running applications
- Work seamlessly with **backend authorization**

Without standardized authentication, projects would implement inconsistent authentication patterns, creating security vulnerabilities and poor user experiences.

## Decision

All **frontends built on the Dasolve framework** must support **Azure Active Directory (Azure AD)** authentication using the **Microsoft Authentication Library (MSAL)** for JavaScript.

Azure AD authentication will be implemented with:

- **MSAL.js** for token acquisition and management
- **OAuth 2.0 / OpenID Connect** protocols
- **Single Sign-On (SSO)** integration with Azure AD
- **Token forwarding** to backend for authorization
- **Automatic token refresh** to maintain sessions in long-running applications
- **Protected routes** that require authentication before access

This decision ensures all Dasolve solutions integrate securely with enterprise Azure AD infrastructure while providing consistent authentication patterns.

## Do's and Don'ts

### Do

- **DO** use MSAL.js for all Azure AD authentication operations.
- **DO** implement Single Sign-On (SSO) with Azure AD for seamless user experience.
- **DO** protect routes that require authentication using TanStack Router guards.
- **DO** forward access tokens to backend APIs for authorization.
- **DO** handle token expiration and automatic refresh gracefully.
- **DO** implement proper error handling for authentication failures.
- **DO** store tokens securely using MSAL's built-in storage mechanisms.
- **DO** provide clear feedback to users during authentication flows (loading states, errors).
- **DO** implement logout functionality that clears tokens and sessions properly.

### Don't

- **DON'T** store tokens in localStorage manually. Use MSAL's token cache.
- **DON'T** implement custom authentication flows. Use MSAL's provided methods.
- **DON'T** send tokens in URL parameters. Always use Authorization headers.
- **DON'T** hardcode Azure AD configuration. Use environment variables.
- **DON'T** skip token validation in the backend.
- **DON'T** implement authentication without proper error boundaries.
- **DON'T** forget to handle token refresh for long-running sessions.

## Consequences

### Positive

- **Enterprise Integration:** Seamless integration with Azure AD provides SSO for enterprise users.
- **Security:** MSAL handles token management securely, following OAuth 2.0 and OpenID Connect best practices.
- **User Experience:** SSO eliminates repeated login prompts across enterprise applications.
- **Token Management:** Automatic token refresh maintains sessions in long-running applications without user intervention.
- **Standards Compliance:** Uses industry-standard protocols (OAuth 2.0, OpenID Connect).
- **Microsoft Support:** MSAL is officially supported and maintained by Microsoft.
- **Integration:** Works seamlessly with backend Azure AD validation.

### Negative

- **Vendor Lock-in:** Tightly couples authentication to Azure AD and Microsoft ecosystem.
- **Complexity:** OAuth 2.0 / OpenID Connect flows add complexity compared to simple username/password.
- **Configuration:** Requires Azure AD app registration and proper configuration.
- **Learning Curve:** Developers must understand OAuth 2.0, OpenID Connect, and MSAL concepts.

### Risks

- **Token Expiration:** Long-running sessions might experience token expiration. This will be mitigated by:
  - Implementing automatic token refresh with MSAL
  - Graceful handling of refresh failures with re-authentication prompts
  - Monitoring token expiration times
- **Configuration Errors:** Incorrect Azure AD configuration can prevent authentication. This will be mitigated by:
  - Providing clear documentation and examples
  - Using environment variables for configuration
  - Validating configuration at application startup

## Compliance and Enforcement

### Enforcement

- **Project Templates:** All Dasolve frontend scaffolding will include Azure AD authentication pre-configured with:
  - MSAL.js library installed
  - Authentication context provider
  - Protected route examples
  - Login/logout components
  - Token forwarding to API clients
- **Environment Configuration:** Azure AD configuration will be managed via environment variables:
  ```typescript
  const msalConfig = {
    auth: {
      clientId: import.meta.env.VITE_AZURE_AD_CLIENT_ID,
      authority: import.meta.env.VITE_AZURE_AD_AUTHORITY,
      redirectUri: import.meta.env.VITE_AZURE_AD_REDIRECT_URI,
    },
    cache: {
      cacheLocation: "sessionStorage",
      storeAuthStateInCookie: false,
    },
  };
  ```
- **Code Reviews:** Reviewers must ensure:
  - MSAL is used for all authentication operations
  - Tokens are forwarded securely to backend APIs
  - Protected routes properly check authentication status
  - Error handling is implemented for authentication failures
  - No custom authentication implementations bypass MSAL

### Standard Implementation

Example MSAL setup and usage:

```typescript
import { PublicClientApplication } from "@azure/msal-browser";
import { MsalProvider, useMsal } from "@azure/msal-react";

// MSAL configuration
const msalConfig = {
  auth: {
    clientId: import.meta.env.VITE_AZURE_AD_CLIENT_ID!,
    authority: `https://login.microsoftonline.com/${
      import.meta.env.VITE_AZURE_AD_TENANT_ID
    }`,
    redirectUri: window.location.origin,
  },
  cache: {
    cacheLocation: "sessionStorage",
    storeAuthStateInCookie: false,
  },
};

const msalInstance = new PublicClientApplication(msalConfig);

// App wrapper with MSAL provider
function App() {
  return (
    <MsalProvider instance={msalInstance}>
      <AuthenticatedApp />
    </MsalProvider>
  );
}

// Component using authentication
function AuthenticatedApp() {
  const { instance, accounts } = useMsal();
  const isAuthenticated = accounts.length > 0;

  const handleLogin = async () => {
    try {
      await instance.loginPopup({
        scopes: ["User.Read"],
      });
    } catch (error) {
      console.error("Login failed:", error);
    }
  };

  const handleLogout = async () => {
    await instance.logoutPopup();
  };

  if (!isAuthenticated) {
    return <LoginPage onLogin={handleLogin} />;
  }

  return <AuthenticatedRoutes onLogout={handleLogout} />;
}
```

Example protected route:

```typescript
import { createFileRoute, redirect } from "@tanstack/react-router";
import { msalInstance } from "./auth-config";

export const Route = createFileRoute("/dashboard")({
  beforeLoad: async () => {
    const accounts = msalInstance.getAllAccounts();
    if (accounts.length === 0) {
      throw redirect({ to: "/login" });
    }
  },
  component: Dashboard,
});
```

Example API call with token:

```typescript
import { useMsal } from "@azure/msal-react";

function useApiClient() {
  const { instance, accounts } = useMsal();

  const getAccessToken = async () => {
    const request = {
      scopes: ["api://your-api-client-id/.default"],
      account: accounts[0],
    };

    try {
      const response = await instance.acquireTokenSilent(request);
      return response.accessToken;
    } catch (error) {
      // Token expired, acquire new token
      const response = await instance.acquireTokenPopup(request);
      return response.accessToken;
    }
  };

  return { getAccessToken };
}
```

### Exceptions

- Applications that don't require authentication (public-facing tools, landing pages) may omit Azure AD integration.
- Alternative authentication providers may be used if explicitly required by the business.
- Other exceptions to this ADR are rare and must be approved by the project's lead architect or the Dasolve framework core maintainers.
- All approved exceptions must be documented as a separate ADR that outlines the business/technical justification and the scope of the exception.

## References

- [MSAL.js Documentation](https://docs.microsoft.com/en-us/azure/active-directory/develop/msal-overview)
- [Azure AD Authentication Flows](https://docs.microsoft.com/en-us/azure/active-directory/develop/authentication-flows-app-scenarios)
- [MSAL React Documentation](https://github.com/AzureAD/microsoft-authentication-library-for-js/tree/dev/lib/msal-react)
