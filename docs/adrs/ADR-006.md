# ADR-006: Node.js Peer Runtime for Incompatible Development Tools

## Context

[ADR-005](./ADR-005.md) establishes **Bun** as the primary and mandatory runtime for our production applications. [ADR-003](./ADR-003.md) standardizes on **Bun** as our package manager.

However, some essential, community-driven tools (e.g., Storybook, Docusaurus) are used _only_ during the **development and build phases**. These tools are built for the Node.js runtime and are currently incompatible with the `bun` runtime.

If these tools are executed (by any mechanism), they will fail if their expected `node` runtime is not available in the environment's `PATH`.

This ADR defines how to provide this required runtime _without_ polluting our production environment.

## Decision

The **Node.js** runtime (`node`) **must be installed** in all **development and build-stage** CI/CD environments as a "peer runtime."

The _sole purpose_ of this peer runtime is to be available for executing known incompatible development tools (e.g., Storybook, Docusaurus).

The `node` runtime **must not** be used to execute our own application code (which is `bun`'s role, per [ADR-005](./ADR-005.md)) and **must not** be included in the final **production environment**.

## Do's and Don'ts

### Do

- **DO** ensure that `node` is installed alongside `bun` _only_ in development and build environments (e.g., local machines, `builder` stage of a Dockerfile).
- **DO** use multi-stage Dockerfiles to ensure the final `production` stage _only_ contains `bun`.
- **DO** rely on this `node` installation _only_ for running the binaries of incompatible, pre-approved development tools.

### Don't

- **DON'T** install `node` in the final `production` stage of your application's `Dockerfile` or production server environment.
- **DON'T** use `node` to execute _your own application's_ TypeScript code. That is _always_ `bun` (per [ADR-005](./ADR-005.md)).
- **DON'T** use `npm`, `pnpm`, or `yarn` for package management (per [ADR-003](./ADR-003.md)).

## Consequences

- **Positive:**

  - **Clean Production Environment:** This is the key benefit. Our production environments remain lean, secure, and fast, containing _only_ the `bun` runtime.
  - **Unblocks Critical Tools:** We can use essential tools like Storybook and Docusaurus in our development workflow.
  - **Maintains Runtime Purity:** We don't compromise our primary `bun` runtime for our _actual application_.

- **Negative:**

  - **Environment Divergence:** This creates a known, accepted divergence between development/build environments (which have `bun` + `node`) and production (which has `bun` only).
  - **Environment Complexity:** We must install, manage, and keep updated _two_ JavaScript runtimes in our dev/build environments.
  - **"Hidden" Dependency:** A developer on a new machine might only install `bun` and be confused by an error when a tool (like Storybook) fails because `node` is missing.

- **Risks:**
  - **Developer Confusion:** Developers might see `node` installed in their dev environment and mistakenly use it directly for application code, bypassing `bun`.

## Compliance and Enforcement

- **Enforcement:** Compliance will be enforced through environment configuration, specifically multi-stage Dockerfiles.
- **Multi-stage Dockerfiles:** This is the primary enforcement mechanism.
  - The `builder` stage (used for `bun install`, building, etc.) **must** have `node` and `bun`.
  - The final `production` stage, which copies from the `builder`, **must not** install `node` and must only contain `bun`.
- **CI/CD Pipelines:** The CI pipeline can include a step to inspect the final production image and fail the build if the `node` binary is present.
- **Code Reviews:** Reviewers must check `Dockerfile`s to ensure this multi-stage pattern is followed and that `node` is not present in the final stage.

## References

- [ADR-001: Primary Programming Language](./ADR-001.md)
- [ADR-003: JavaScript/TypeScript Package Manager](./ADR-003.md)
- [ADR-005: Primary TypeScript Runtime](./ADR-005.md)
