# ADR-005: Primary TypeScript Runtime

## Context

[ADR-001](./ADR-001.md) establishes TypeScript as our primary programming language. [ADR-003](./ADR-003.md) standardizes on Bun as our package manager.

A TypeScript application needs a _runtime_â€”an environment to execute the code. The traditional approach is to transpile TypeScript (`.ts`) to JavaScript (`.js`) using `tsc`, and then execute that JavaScript using the **Node.js** runtime. For development, this requires complex workarounds like `ts-node` and `nodemon` for hot-reloading.

Bun is not only a package manager; it is also a complete, high-performance runtime that can execute TypeScript files directly, in-memory, with no separate build step.

This ADR decides on the official execution environment for our TypeScript code, specifically for backend applications and frontend development servers. Task execution (i.e., `package.json` scripts) will be defined in a separate ADR.

## Decision

The primary and mandatory runtime for executing TypeScript code is **Bun**.

This decision explicitly replaces the Node.js runtime (`node`). It applies to two specific use cases:

1.  **Backend Applications:** All TypeScript-based backend services **must** be executed by the `bun` runtime.
2.  **Frontend Development (Vite):** The Vite development server **must** be launched using `bun` as its runtime.

This decision eliminates the need for `ts-node`, `nodemon`, and a separate `tsc` transpilation step _for execution_.

Note that while Bun _executes_ TypeScript, it does not _type-check_ it. Static type-checking remains a separate, mandatory step in our workflow (see Compliance).

## Do's and Don'ts

### Do

- **DO** execute your backend TypeScript files directly using `bun` (e.g., `bun src/index.ts`).
- **DO** use `bun --watch src/index.ts` for high-speed, built-in hot-reloading on your backend services during development.
- **DO** launch your Vite development server using `bun` (e.g., `bun run vite dev`).
- **DO** maintain a separate script for static type-checking using `tsc --noEmit`.

### Don't

- **DON'T** use `node` (e.g., `node build/index.js`) to run your application in any environment.
- **DON'T** install, use, or add `ts-node`, `nodemon`, or `ts-node-dev` as `devDependencies`. `bun --watch` fully replaces them for development.
- **DON'T** maintain a `tsc` build step that transpiles TypeScript to JavaScript _for the purpose of execution_. We run TypeScript files directly.
- **DON'T** assume `bun` is type-checking your code.

## Consequences

- **Positive:**

  - **Extreme Simplicity:** We can remove a large number of `devDependencies` (`ts-node`, `nodemon`, `@types/node`, etc.). The development toolchain becomes much smaller and simpler.
  - **Unmatched Performance:** Bun's startup time and hot-reloading speed are orders of magnitude faster than the `ts-node` + `nodemon` equivalent, leading to a superior developer experience.
  - **Unified Toolchain:** We are building a consistent developer experience around a single toolchain (`bun`), as started in [ADR-003](./ADR-003.md).
  - **First-Class TS:** TypeScript (and JSX) are treated as first-class citizens by the runtime.

- **Negative:**

  - **Node.js API Compatibility:** This is the primary risk. While Bun has near-complete Node.js API compatibility, it is not 100%. An obscure `npm` package that relies on native C++ bindings or internal Node.js APIs may not function correctly.
  - **Maturity:** We are committing to a runtime that is much newer than Node.js. This carries an "early adopter" risk of undiscovered bugs.

- **Risks:**
  - **Incompatibility:** The most significant risk is that a critical third-party library (or Vite itself) is incompatible with the Bun runtime.
  - **Mitigation:** Critical libraries must be validated for Bun compatibility. Incompatible libraries will require a formal exception (see below).

## Compliance and Enforcement

- **Enforcement:** Compliance will be enforced through project configuration and CI pipelines.

  - **CI/CD Pipelines:**
    1.  The pipeline **must** include a separate, mandatory static type-checking step (e.g., `tsc --noEmit`). The build will fail if types are invalid.
    2.  The application "start" command **must** use `bun` as the executable (e.g., `bun src/index.ts`).
  - **Code Reviews:** Reviewers must check for the inclusion of forbidden dependencies (`nodemon`, `ts-node`, etc.) and ensure no `node` or `ts-node` commands are used to run the application.

- **Exceptions:**
  - Any exception to use the Node.js runtime (e.g., due to a critical, incompatible library, or a deployment target that _only_ supports Node.js) must be approved by the Dasolve core team and documented in a separate ADR.

## References

- [ADR-001: Primary Programming Language](./ADR-001.md)
- [ADR-003: JavaScript/TypeScript Package Manager](./ADR-003.md)
